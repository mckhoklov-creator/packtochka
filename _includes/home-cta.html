<section class="home-cta">
  <div class="cta-container">
    <div class="cta-text">
      <h2>Поможем с выбором упаковки для любых задач</h2>
      <p>Подберём размеры и материал, рассчитаем стоимость и сроки. Ответим на любые вопросы.</p>
      <div class="cta-buttons">
        <a href="{{ site.baseurl }}/katalog/" class="btn btn-primary">Перейти в каталог</a>
        <a href="{{ site.baseurl }}/opt/" class="btn btn-outline">Скачать прайс</a>
      </div>
    </div>

    <div class="cta-form">
      <!-- невидимый iframe: чтобы не уводить пользователя на formcarry -->
      <iframe name="fc_iframe_cta" style="display:none;"></iframe>

      <form class="fc-form"
            action="https://formcarry.com/s/N7tSL3GkBZW"
            method="POST"
            target="fc_iframe_cta">
        <!-- служебные поля -->
        <input type="hidden" name="source_form" value="cta">
        <input type="hidden" name="page_url" value="">

        <input type="text" name="name" placeholder="Ваше имя" required>

        <input type="tel" name="phone" placeholder="+7 (___) ___-__-__" required>

        <textarea name="message" placeholder="Напишите свой вопрос"></textarea>

        <button type="submit" class="btn btn-primary">Отправить</button>
        <p class="privacy-note">
          Нажимая «Отправить», вы соглашаетесь с
          <a href="{{ site.baseurl }}/privacy/">политикой конфиденциальности</a>.
        </p>
      </form>
    </div>
  </div>
</section>

<script>
/* Мини-хелпер на случай, если глобальный скрипт на странице не подключён:
   - подставляет page_url
   - делает мягкий редирект на /spasibo/ после отправки (Free-план Formcarry)
   - добавляет простую маску телефона для этой формы
*/
(function () {
  var form = document.currentScript && document.currentScript.previousElementSibling
    ? document.currentScript.previousElementSibling.querySelector('form.fc-form')
    : document.querySelector('.home-cta form.fc-form');

  if (!form) return;

  // page_url
  var urlField = form.querySelector('input[name="page_url"]');
  if (urlField) urlField.value = window.location.href;

  // редирект
  form.addEventListener('submit', function () {
    setTimeout(function () {
      window.location.href = 'https://packtochka.ru/spasibo/';
    }, 600);
  });

  // мягкая маска для телефона (короткая версия)
  var input = form.querySelector('input[name="phone"]');
  if (!input) return;

  function onlyDigits(s){ return (s.match(/\d/g)||[]).join(''); }
  function digitsCountIn(s){ return (s.match(/\d/g)||[]).length; }
  function norm(d){ if(d.startsWith('8')) d='7'+d.slice(1); if(!d.startsWith('7')) d='7'+d; return d.slice(0,11); }
  function fmt(d){
    if(!d) return '';
    var out = '+7';
    if(d.length>1) out+=' ('+d.slice(1,4);
    if(d.length>=4) out+=')';
    if(d.length>4) out+=' '+d.slice(4,7);
    if(d.length>7) out+='-'+d.slice(7,9);
    if(d.length>9) out+='-'+d.slice(9,11);
    return out;
  }
  function caretPos(s,k){
    if(k<=0){ var i=s.indexOf('7'); return i>=0? i+1 : 0; }
    var c=0; for(var i=0;i<s.length;i++){ if(/\d/.test(s[i])){ c++; if(c===k) return i+1; } }
    return s.length;
  }

  input.addEventListener('focus', function(){
    if(!onlyDigits(input.value)){
      input.value = '+7 ';
      setTimeout(function(){ input.setSelectionRange(input.value.length, input.value.length); },0);
    }
  });

  input.addEventListener('input', function(){
    var sel = input.selectionStart||0;
    var before = input.value.slice(0,sel);
    var k = digitsCountIn(before);
    var d = norm(onlyDigits(input.value));
    var s = fmt(d);
    input.value = s;
    var p = caretPos(s,k);
    input.setSelectionRange(p,p);
  });

  input.addEventListener('keydown', function(e){
    if(e.key!=='Backspace' && e.key!=='Delete') return;
    var selStart=input.selectionStart||0, selEnd=input.selectionEnd||0;
    var d = norm(onlyDigits(input.value));
    var kLeft = digitsCountIn(input.value.slice(0,selStart));
    function killRange(L,R){ var keep='',i=0; for(var ch of d){ if(i<L||i>=R) keep+=ch; i++; } d=keep; }
    if (selEnd>selStart){ killRange(kLeft, digitsCountIn(input.value.slice(0,selEnd))); }
    else if(e.key==='Backspace' && kLeft>0){ killRange(kLeft-1, kLeft); }
    else if(e.key==='Delete'   && kLeft<d.length){ killRange(kLeft, kLeft+1); }
    else return;
    var s=fmt(d); input.value=s;
    var newPos = caretPos(s, e.key==='Backspace' ? Math.max(0,kLeft-1) : kLeft);
    input.setSelectionRange(newPos,newPos); e.preventDefault();
  });

  input.addEventListener('blur', function(){
    var d = onlyDigits(input.value);
    if(d.length<11) input.value = '';
  });
})();
</script>
